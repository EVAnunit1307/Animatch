<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Animatch</title>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #22d3ee;
      --accent-2: #8b5cf6;
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #0b1221, #0f172a);
      color: var(--text);
    }
    h1 { margin: 0 0 12px; }
    .app {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
      align-items: start;
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    label { font-size: 14px; color: var(--muted); }
    input[type=file] { color: var(--text); }
    button {
      background: var(--accent);
      color: #0f172a;
      border: none;
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 12px;
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .toggles { display: flex; gap: 12px; margin-top: 8px; }
    .status { margin-top: 10px; font-size: 14px; color: var(--muted); }
    .quality {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .quality .item {
      background: var(--card);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .quality .ok { color: var(--ok); }
    .quality .warn { color: var(--warn); }
    .quality .bad { color: var(--bad); }
    .matches { display: grid; gap: 12px; margin-top: 12px; }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 12px;
      display: grid;
      grid-template-columns: 140px 1fr;
      gap: 12px;
      align-items: center;
    }
    .bar {
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
      margin: 6px 0;
    }
    .bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
    }
    .reasons { margin: 6px 0 0; padding-left: 18px; color: var(--muted); font-size: 13px; }
    .overlay {
      margin-top: 12px;
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
    }
    @media (max-width: 960px) {
      .app { grid-template-columns: 1fr; }
      .card { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <h1>Animatch</h1>
  <div class="app">
    <div class="panel">
      <label>Upload an image</label><br>
      <input type="file" id="file" accept="image/*"><br>
      <div class="toggles">
        <label><input type="checkbox" id="returnImage" checked> return landmarks</label>
        <label><input type="checkbox" id="debug" > debug</label>
      </div>
      <button id="go">Match</button>
      <div class="status" id="status">Idle</div>
      <div id="quality"></div>
      <img id="overlay" class="overlay" style="display:none" alt="Landmarks overlay">
    </div>
    <div class="panel">
      <h3 style="margin:0 0 8px;">Matches</h3>
      <div id="compare" style="display:none; margin-bottom:12px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
          <div>
            <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Your landmarks</div>
            <img id="overlayCompare" class="overlay" style="display:none" alt="Your overlay">
          </div>
          <div>
            <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Selected match</div>
            <img id="matchCompare" class="overlay" style="display:none" alt="Match image">
            <img id="matchOverlayCompare" class="overlay" style="display:none; margin-top:6px;" alt="Match overlay">
          </div>
        </div>
      </div>
      <div class="matches" id="matches"></div>
    </div>
  </div>

  <script>
    const api = "http://127.0.0.1:8000/match";
    const go = document.getElementById("go");
    const statusEl = document.getElementById("status");
    const qualityEl = document.getElementById("quality");
    const matchesEl = document.getElementById("matches");
    const overlayEl = document.getElementById("overlay");
    const overlayCompare = document.getElementById("overlayCompare");
    const matchCompare = document.getElementById("matchCompare");
    const matchOverlayCompare = document.getElementById("matchOverlayCompare");
    const compareBlock = document.getElementById("compare");

    function qualityItem(label, value, ok=true) {
      const cls = ok === true ? "ok" : ok === false ? "bad" : "warn";
      return `<div class="item"><strong>${label}</strong><br><span class="${cls}">${value}</span></div>`;
    }

    function renderQuality(q) {
      if (!q) { qualityEl.innerHTML = ""; return; }
      const items = [];
      items.push(qualityItem("Lighting", q.lighting_ok ? "OK" : "Low", q.lighting_ok));
      items.push(qualityItem("Angle", q.angle_ok ? "OK" : "Off", q.angle_ok));
      if (q.blur_score !== undefined) {
        items.push(qualityItem("Sharpness", q.sharpness_ok ? `OK (${q.blur_score})` : `Low (${q.blur_score})`, q.sharpness_ok));
      }
      if (q.face_size_ok !== undefined) {
        items.push(qualityItem("Face Size", q.face_size_ok ? "OK" : "Too small", q.face_size_ok));
      }
      if (q.brightness !== undefined) {
        items.push(qualityItem("Brightness", q.brightness, q.lighting_ok));
      }
      if (q.confidence !== undefined) {
        items.push(qualityItem("Confidence", q.confidence, q.confidence >= 0.5 ? true : false));
      }
      qualityEl.innerHTML = `<div class="quality">${items.join("")}</div>`;
      if (q.warnings && q.warnings.length) {
        qualityEl.innerHTML += `<div style="margin-top:8px;font-size:13px;color:var(--warn);">Warnings: ${q.warnings.join(", ")}</div>`;
      }
    }

    function renderMatches(list) {
      matchesEl.innerHTML = "";
      if (!list || list.length === 0) {
        matchesEl.innerHTML = "<div style='color:var(--muted)'>No matches.</div>";
        return;
      }
      list.forEach((m, idx) => {
        const pct = m.similarity_pct !== undefined ? m.similarity_pct : Math.min(100, Math.max(0, (m.similarity || 0) * 100));
        const reasons = (m.reasons || []).map(r => `<li>${r.reason} (Î” ${r.difference})</li>`).join("");
        const img = m.image_url ? `<img src="${m.image_url}" alt="${m.name}" style="width:120px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);">` : "";
        const badge = pct >= 60 ? "Good" : pct >= 40 ? "OK" : "Weak";
        const card = `
          <div class="card">
            ${img || "<div style='width:120px;height:120px;background:rgba(255,255,255,0.05);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted);'>No image</div>"}
            <div>
              <div style="font-weight:700;font-size:16px;">${m.name || m.id}</div>
              <div style="color:var(--muted);font-size:13px;">${m.series || ""}</div>
              <div class="bar"><span style="width:${pct}%;"></span></div>
              <div style="font-size:13px;color:var(--muted);">Similarity: ${pct.toFixed(1)}% (${badge})</div>
              <ul class="reasons">${reasons}</ul>
              <button class="view-btn" data-idx="${idx}" style="margin-top:6px;padding:6px 10px;border-radius:6px;background:var(--accent-2);color:white;border:none;cursor:pointer;">View side-by-side</button>
            </div>
          </div>
        `;
        matchesEl.insertAdjacentHTML("beforeend", card);
      });
    }

    go.onclick = async () => {
      const f = document.getElementById("file").files[0];
      if (!f) return alert("Pick a file");
      const form = new FormData();
      form.append("file", f);
      const params = new URLSearchParams();
      params.set("return_image", document.getElementById("returnImage").checked);
      params.set("debug", document.getElementById("debug").checked);
      statusEl.textContent = "Uploading...";
      overlayEl.style.display = "none";
      overlayEl.src = "";
      overlayCompare.style.display = "none";
      matchCompare.style.display = "none";
      matchOverlayCompare.style.display = "none";
      compareBlock.style.display = "none";
      qualityEl.innerHTML = "";
      matchesEl.innerHTML = "";
      try {
        const res = await fetch(`${api}?${params.toString()}`, { method: "POST", body: form });
        const data = await res.json();
        if (!res.ok) {
          statusEl.textContent = `Error: ${data.detail || res.status}`;
          return;
        }
        statusEl.textContent = "Done";
        renderQuality(data.quality);
        renderMatches(data.matches);
        if (data.debug_image_b64) {
          overlayEl.src = "data:image/png;base64," + data.debug_image_b64;
          overlayEl.style.display = "block";
          overlayCompare.src = overlayEl.src;
          overlayCompare.style.display = "block";
        }
        // attach click handlers for side-by-side
        document.querySelectorAll(".view-btn").forEach(btn => {
          btn.onclick = () => {
            const idx = parseInt(btn.dataset.idx, 10);
            const m = data.matches[idx];
            if (m && m.image_url) {
              matchCompare.src = m.image_url;
              matchCompare.style.display = "block";
            } else {
              matchCompare.style.display = "none";
            }
            if (m && m.overlay_url) {
              matchOverlayCompare.src = m.overlay_url;
              matchOverlayCompare.style.display = "block";
            } else {
              matchOverlayCompare.style.display = "none";
            }
            if (matchCompare.style.display === "block" || matchOverlayCompare.style.display === "block") {
              compareBlock.style.display = "block";
            }
          };
        });
      } catch (e) {
        statusEl.textContent = `Error: ${e}`;
      }
    };
  </script>
</body>
</html>
