<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Animatch</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500;600&display=swap');
    :root {
      --bg: #060814;
      --panel: rgba(5,6,8,0.92);
      --card: rgba(7,8,11,0.9);
      --text: #f5f7fb;
      --muted: #9fb0c0;
      --accent: #6de4c7;
      --accent-2: #f7b267;
      --ok: #4fe3b5;
      --warn: #f7c45f;
      --bad: #ef7777;
      --glass: rgba(255,255,255,0.08);
    }
    .card img { max-width: 110px; }
    .matches-panel { grid-column: 1 / -1; width: 100%; }
    .skeleton-card {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 12px;
      min-height: 130px;
      position: relative;
      overflow: hidden;
    }
    .skeleton-card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
      animation: shimmer 1.8s infinite;
    }
    .sk-img { width: 110px; height: 130px; border-radius: 10px; background: rgba(255,255,255,0.06); }
    .sk-line { height: 10px; border-radius: 999px; background: rgba(255,255,255,0.06); margin: 6px 0; }
    .sk-small { width: 60%; }
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: "Helvetica Neue", "Inter", "Segoe UI", sans-serif;
      letter-spacing: 0.01em;
      color: var(--text);
      background: linear-gradient(135deg, #05070f, #070a14 60%, #05070f);
      position: relative;
      overflow-x: hidden;
    }
    .network-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      opacity: 0.22;
      mix-blend-mode: screen;
    }
    .network-bg svg { width: 100%; height: 100%; }
    .network-line {
      stroke: rgba(255,255,255,0.08);
      stroke-width: 1.2;
      fill: none;
      stroke-dasharray: 6 12;
      animation: dash 10s linear infinite;
    }
    @keyframes dash {
      to { stroke-dashoffset: -200; }
    }
    .network-dot { fill: rgba(255,255,255,0.18); }
    .container { max-width: 1400px; margin: 0 auto; }
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    .logo { font-weight: 800; letter-spacing: 0.04em; font-size: 20px; }
    .top-actions { display: flex; gap: 10px; }
    .ghost-btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
      transition: all 160ms ease;
    }
    .ghost-btn:hover { border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.04); }
    h1 { margin: 0 0 8px; font-size: 48px; font-family: "Orbitron", "Helvetica Neue", sans-serif; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase; }
    .subtitle { color: #dfe4ec; margin: 0 0 6px; font-size: 14px; max-width: 640px; line-height: 1.4; font-family: "Inter", "Helvetica Neue", sans-serif; letter-spacing: 0.03em; text-transform: none; font-weight: 600; }
    .hero {
      position: relative;
      margin-bottom: 12px;
      min-height: 70vh;
      background: #030405;
      border-radius: 24px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 30px 80px rgba(0,0,0,0.55);
    }
    .hero-core {
      position: relative;
      z-index: 1;
      display: grid;
      place-items: center;
      padding: 120px 24px 100px;
      text-align: center;
      gap: 14px;
    }
    .hero-title {
      font-family: "Orbitron", "Helvetica Neue", sans-serif;
      font-size: 80px;
      letter-spacing: 0.1em;
      color: #f3f4f7;
      margin: 0;
      text-transform: uppercase;
      font-weight: 700;
    }
    .hero-sub {
      font-family: "Inter", "Helvetica Neue", sans-serif;
      font-size: 16px;
      color: #c5c9d2;
      letter-spacing: 0.04em;
      margin: 0;
      text-transform: none;
      font-weight: 600;
    }
    .portal-btn {
      padding: 14px 24px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(120deg, rgba(116,217,255,0.2), rgba(78,224,196,0.2));
      color: #eaf5f0;
      font-weight: 800;
      letter-spacing: 0.06em;
      cursor: pointer;
      box-shadow: 0 12px 40px rgba(0,0,0,0.4), 0 0 18px rgba(109,228,199,0.25);
      transition: transform 160ms ease, box-shadow 160ms ease;
    }
    .portal-btn:hover { transform: translateY(-2px); box-shadow: 0 18px 50px rgba(0,0,0,0.5), 0 0 24px rgba(109,228,199,0.35); }
    .poster-field {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .poster-stack {
      position: absolute;
      width: 126px;
      aspect-ratio: 5/7;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 32px rgba(0,0,0,0.45);
      opacity: 0.7;
      animation: bounce 10s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    .poster-stack img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      filter: saturate(0.9);
    }
    @keyframes bounce {
      0% { transform: translate3d(0,0,0) rotate(-4deg); opacity: 0.6; }
      40% { transform: translate3d(8px,-16px,0) rotate(2deg); opacity: 0.95; }
      70% { transform: translate3d(-6px,10px,0) rotate(-1deg); opacity: 0.8; }
      100% { transform: translate3d(0,0,0) rotate(-4deg); opacity: 0.6; }
    }
    @keyframes marquee {
      from { transform: translateX(0); }
      to { transform: translateX(-50%); }
    }
    .card-preview {
      flex: 0 0 140px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 10px;
      display: grid;
      gap: 8px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.3);
      transition: transform 160ms ease, box-shadow 160ms ease;
    }
    .card-preview img {
      width: 100%;
      border-radius: 10px;
      object-fit: cover;
      aspect-ratio: 3 / 4;
      background: #0b1221;
    }
    .card-preview .title { font-size: 13px; font-weight: 700; }
    .card-preview .series { font-size: 11px; color: var(--muted); }
    .eyebrow { text-transform: uppercase; letter-spacing: 0.08em; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    .hero-badges { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .hero-card {
      background: rgba(5,6,8,0.9);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 18px;
      padding: 14px;
      display: grid;
      gap: 10px;
      max-width: 100%;
      width: 100%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.45);
    }
    .hero-metric { background: rgba(255,255,255,0.02); border-radius: 12px; padding: 10px; border: 1px solid rgba(255,255,255,0.04); }
    .metric-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted); }
    .metric-text { font-size: 14px; color: var(--text); margin-top: 4px; line-height: 1.5; }
    .section {
      position: relative;
      padding: 10px 0;
    }
    .section + .section { margin-top: 10px; }
    .reveal {
      opacity: 0;
      transform: translateY(22px);
      transition: opacity 600ms ease, transform 600ms ease;
      will-change: opacity, transform;
    }
    .reveal.in-view {
      opacity: 1;
      transform: translateY(0);
    }
    @media (prefers-reduced-motion: reduce) {
      .reveal { opacity: 1; transform: none; transition: none; }
    }
    .app {
      display: grid;
      grid-template-columns: 420px 1fr;
      gap: 16px;
      align-items: start;
    }
    .panel {
      background: var(--panel);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 18px 34px rgba(0,0,0,0.38);
      backdrop-filter: blur(10px);
    }
    .upload-panel {
      grid-column: 1 / -1;
      position: relative;
      overflow: hidden;
      padding: 22px;
      border-radius: 18px;
      background: rgba(5,6,8,0.94);
      border: 1px solid rgba(255,255,255,0.05);
      box-shadow: 0 26px 64px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.03);
      text-align: left;
    }
    .upload-content { position: relative; z-index: 1; display: grid; gap: 16px; }
    .upload-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 220px;
      gap: 18px;
      align-items: start;
    }
    .upload-left { display: grid; gap: 12px; }
    .upload-heading { display: grid; gap: 4px; }
    .upload-title { font-size: 15px; font-weight: 600; letter-spacing: 0.03em; }
    .upload-sub { font-size: 12px; color: rgba(199,204,211,0.7); letter-spacing: 0.03em; }
    .upload-field { display: grid; gap: 6px; }
    .field-label { font-size: 11px; letter-spacing: 0.08em; text-transform: uppercase; color: rgba(199,204,211,0.6); }
    .file-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      align-items: center;
      padding: 6px 0;
      border-radius: 0;
      background: transparent;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    .file-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      border-radius: 0;
      border: none;
      background: transparent;
      color: #d7dde5;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
    }
    .file-button:hover { color: #ffffff; }
    .file-name {
      font-size: 12px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .file-input { display: none; }
    .range-row {
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text);
    }
    .range-input { flex: 1; }
    .range-input {
      -webkit-appearance: none;
      appearance: none;
      height: 2px;
      background: rgba(255,255,255,0.15);
      border-radius: 999px;
      outline: none;
    }
    .range-input::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #d7dde5;
      border: 2px solid #0b0f14;
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08);
    }
    .range-input::-moz-range-thumb {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #d7dde5;
      border: 2px solid #0b0f14;
      box-shadow: 0 0 0 6px rgba(255,255,255,0.08);
    }
    .range-input::-moz-range-track {
      height: 2px;
      background: rgba(255,255,255,0.15);
      border-radius: 999px;
    }
    .range-value {
      width: 32px;
      text-align: center;
      font-weight: 600;
      font-size: 12px;
      color: rgba(199,204,211,0.9);
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.02);
      padding: 4px 0;
    }
    .toggle-row { display: flex; flex-wrap: wrap; gap: 10px; }
    .toggle-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.02);
      font-size: 12px;
      color: var(--text);
    }
    .upload-right { display: grid; gap: 10px; align-content: center; }
    .upload-actions { display: grid; gap: 10px; }
    .btn {
      border-radius: 12px;
      padding: 11px 14px;
      font-weight: 700;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.03);
      color: #d7dde5;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 0;
      box-shadow: 0 10px 22px rgba(0,0,0,0.25);
      transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
    }
    .upload-actions .btn { width: 100%; }
    .btn.primary {
      background: rgba(255,255,255,0.16);
      color: #f5f7fb;
      border-color: rgba(255,255,255,0.28);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
    }
    .btn:hover:not(:disabled) { transform: translateY(-1px); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    label { font-size: 14px; color: var(--muted); }
    input[type=file] { color: var(--text); }
    button {
      background: linear-gradient(120deg, var(--accent), var(--accent-2));
      color: #0b1221;
      border: none;
      border-radius: 10px;
      padding: 11px 15px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 12px;
      transition: transform 160ms ease, box-shadow 160ms ease;
      box-shadow: 0 10px 24px rgba(123,92,246,0.25);
    }
    button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; }
    button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(91,224,232,0.3); }
    .toggles { display: flex; gap: 12px; margin-top: 8px; justify-content: center; flex-wrap: wrap; }
    .status { margin-top: 10px; font-size: 14px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 0 6px rgba(34,211,238,0.08); }
    .quality {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 12px;
    }
    .quality .item {
      background: var(--card);
      padding: 10px;
      border-radius: 10px;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .quality .ok { color: var(--ok); }
    .quality .warn { color: var(--warn); }
    .quality .bad { color: var(--bad); }
    .matches {
      display: grid;
      gap: 10px;
      margin-top: 12px;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }
    .card {
      background: var(--card);
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 12px;
      align-items: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      transition: transform 180ms ease, box-shadow 180ms ease;
      min-height: 130px;
    }
    .card:hover { transform: translateY(-2px); box-shadow: 0 12px 30px rgba(0,0,0,0.35); }
    .bar {
      background: rgba(255,255,255,0.08);
      border-radius: 999px;
      overflow: hidden;
      height: 10px;
      margin: 6px 0;
    }
    .bar span {
      display: block;
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      transition: width 220ms ease;
    }
    .reasons { margin: 6px 0 0; padding-left: 18px; color: var(--muted); font-size: 13px; }
    .overlay {
      margin-top: 12px;
      max-width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 10px 28px rgba(0,0,0,0.35);
    }
    .stars {
      position: absolute;
      inset: 0;
      pointer-events: none;
      opacity: 0.04;
      background-image:
        radial-gradient(1.5px 1.5px at 20% 30%, rgba(255,255,255,0.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 60% 70%, rgba(255,255,255,0.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 80% 20%, rgba(255,255,255,0.6), transparent 60%),
        radial-gradient(1.5px 1.5px at 30% 80%, rgba(255,255,255,0.6), transparent 60%);
    }
    .face-preview {
      display: flex;
      gap: 18px;
      align-items: flex-start;
      margin-top: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .mini-stack { display: grid; gap: 10px; flex: 0 0 220px; }
    .match-mini {
      display: grid;
      grid-template-columns: 80px 1fr;
      gap: 10px;
      align-items: center;
      padding: 10px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.07);
      border-radius: 12px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      min-width: 240px;
    }
    .match-mini img {
      width: 80px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    .match-mini .name { font-weight: 700; font-size: 14px; }
    .match-mini .series { font-size: 12px; color: var(--muted); }
    .overlay-frame {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px;
      align-items: start;
    }
    .overlay-frame img {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0b1221;
      object-fit: contain;
    }
    /* Camera modal */
    .camera-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
    }
    .camera-box {
      background: rgba(12,14,22,0.9);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 48px rgba(0,0,0,0.6);
      max-width: 480px;
      width: 100%;
      display: grid;
      gap: 12px;
    }
    .camera-box video {
      width: 100%;
      border-radius: 14px;
      background: #000;
      min-height: 260px;
    }
    .camera-controls {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .camera-btn {
      flex: 1;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: linear-gradient(120deg, rgba(109,228,199,0.18), rgba(247,178,103,0.16));
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .camera-btn.cancel {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
    }
    .series-strip {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 16px;
      align-items: stretch;
      max-height: 520px;
      overflow: auto;
      padding-right: 18px;
      scrollbar-gutter: stable;
    }
    .feature-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr) 280px;
      gap: 32px;
      align-items: start;
    }
    .feature-right {
      justify-self: end;
      width: 280px;
      margin-left: 0;
      display: grid;
      gap: 10px;
    }
    .v-carousel {
      position: relative;
      height: 440px;
      overflow: hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.06);
      background: rgba(10,12,18,0.9);
      mask-image: linear-gradient(180deg, transparent 0%, #000 16%, #000 84%, transparent 100%);
      padding: 14px;
    }
    .v-track {
      display: grid;
      gap: 12px;
      padding-top: 6px;
      padding-bottom: 6px;
      animation: scrollY 32s linear infinite;
      will-change: transform;
    }
    .v-card {
      display: grid;
      gap: 6px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 10px 22px rgba(0,0,0,0.28);
      overflow: hidden;
    }
    .v-card img {
      width: 100%;
      border-radius: 10px;
      height: 140px;
      object-fit: cover;
      background: #0b1221;
    }
    .v-card .title { font-weight: 700; font-size: 13px; }
    .v-card .series { font-size: 12px; color: var(--muted); }
    @keyframes scrollY {
      0% { transform: translateY(0); }
      100% { transform: translateY(-50%); }
    }
    .how-toggle {
      position: fixed;
      right: 22px;
      bottom: 22px;
      z-index: 120;
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(10,12,18,0.92);
      color: #eaf5f0;
      font-weight: 700;
      letter-spacing: 0.04em;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0,0,0,0.35);
    }
    .how-panel {
      position: fixed;
      top: 0;
      right: -360px;
      height: 100%;
      width: 340px;
      background: rgba(8,10,16,0.98);
      border-left: 1px solid rgba(255,255,255,0.06);
      box-shadow: -14px 0 30px rgba(0,0,0,0.4);
      padding: 20px;
      z-index: 121;
      transition: right 200ms ease;
      display: grid;
      gap: 12px;
    }
    .how-panel.open { right: 0; }
    .how-panel h4 { margin: 0; font-size: 14px; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
    .how-panel p { margin: 0; color: #dfe4ec; font-size: 13px; line-height: 1.6; }
    .how-close {
      align-self: start;
      justify-self: end;
      background: none;
      border: 1px solid rgba(255,255,255,0.12);
      color: #eaf5f0;
      padding: 6px 10px;
      border-radius: 10px;
      cursor: pointer;
    }
    .how-section { padding: 10px 0; border-top: 1px solid rgba(255,255,255,0.06); }
    .how-section:first-of-type { border-top: none; }
    .how-section h5 { margin: 0 0 6px; font-size: 12px; letter-spacing: 0.08em; text-transform: uppercase; color: #9fb0c0; }
    .how-section ul { margin: 0; padding-left: 16px; color: #dfe4ec; font-size: 13px; line-height: 1.6; }
    .series-card {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      min-height: 180px;
      background: linear-gradient(160deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.08);
      color: #eaf5f0;
      text-decoration: none;
      display: grid;
      align-content: end;
      padding: 12px;
      box-shadow: 0 14px 36px rgba(0,0,0,0.35);
      transition: transform 160ms ease, box-shadow 160ms ease, border-color 160ms ease;
      background-size: cover;
      background-position: center;
      isolation: isolate;
    }
    .series-card::before {
      content:"";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, transparent 30%, rgba(0,0,0,0.65) 90%);
      z-index: 0;
    }
    .series-card:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: 0 18px 46px rgba(0,0,0,0.45);
      border-color: rgba(109,228,199,0.2);
    }
    .series-card .name {
      position: relative;
      z-index: 1;
      font-weight: 800;
      letter-spacing: 0.04em;
      font-size: 14px;
      text-transform: uppercase;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .stats-panel {
      margin-top: 18px;
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      display: grid;
      gap: 12px;
    }
    .stats-panel .eyebrow { text-align: center; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
    }
    .stat {
      position: relative;
      overflow: hidden;
      background: rgba(5,6,8,0.92);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
      display: grid;
      gap: 6px;
      min-height: 110px;
      text-align: center;
      align-content: center;
      box-shadow: 0 14px 30px rgba(0,0,0,0.4);
    }
    .stat-value {
      font-size: 22px;
      font-weight: 600;
      font-family: "Inter", "Helvetica Neue", sans-serif;
      letter-spacing: 0.02em;
      color: #c7ccd3;
    }
    .stat-value.small {
      font-size: 16px;
      font-family: "Inter", "Helvetica Neue", sans-serif;
      letter-spacing: 0.02em;
      font-weight: 500;
      color: #c7ccd3;
    }
    .stat-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: rgba(199,204,211,0.65);
    }
    .stat-note {
      font-size: 12px;
      color: rgba(199,204,211,0.6);
      letter-spacing: 0.03em;
      text-align: center;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: rgba(255,255,255,0.06);
      border-radius: 999px;
      font-size: 12px;
      color: var(--text);
    }
    .fade-up { animation: fadeUp 260ms ease; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
    .legend {
      margin: 6px 0 8px;
      font-size: 13px;
      color: var(--muted);
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      align-items: center;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      color: #0f172a;
    }
    .badge.good { background: var(--ok); }
    .badge.ok { background: var(--warn); color: #1f2937; }
    .badge.weak { background: #475569; color: #e2e8f0; }
    .info { font-size: 13px; color: var(--muted); margin-top: 4px; }
    @media (max-width: 960px) {
      .app { grid-template-columns: 1fr; }
      .card { grid-template-columns: 1fr; }
      .hero { grid-template-columns: 1fr; }
      .upload-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      body { padding: 12px; }
      .panel { padding: 12px; }
      .card { grid-template-columns: 1fr; }
      .hero { padding: 14px; }
    }
  </style>
</head>
<body>
  <div class="network-bg">
    <svg preserveAspectRatio="xMidYMid slice">
      <g>
        <circle class="network-dot" cx="12%" cy="18%" r="3"></circle>
        <circle class="network-dot" cx="22%" cy="38%" r="2"></circle>
        <circle class="network-dot" cx="32%" cy="24%" r="2.4"></circle>
        <circle class="network-dot" cx="48%" cy="16%" r="3.2"></circle>
        <circle class="network-dot" cx="62%" cy="22%" r="2.5"></circle>
        <circle class="network-dot" cx="72%" cy="34%" r="2.8"></circle>
        <circle class="network-dot" cx="82%" cy="18%" r="3.1"></circle>
        <circle class="network-dot" cx="18%" cy="62%" r="2.6"></circle>
        <circle class="network-dot" cx="36%" cy="58%" r="2.3"></circle>
        <circle class="network-dot" cx="56%" cy="64%" r="2.9"></circle>
        <circle class="network-dot" cx="74%" cy="58%" r="2.2"></circle>
        <circle class="network-dot" cx="88%" cy="64%" r="3.0"></circle>
        <path class="network-line" d="M12 18 L22 38 L32 24 L48 16 L62 22 L72 34 L82 18" />
        <path class="network-line" d="M18 62 L36 58 L56 64 L74 58 L88 64" />
        <path class="network-line" d="M22 38 L18 62 L36 58 L32 24" />
        <path class="network-line" d="M62 22 L56 64 L74 58 L72 34" />
      </g>
    </svg>
  </div>
  <style>
    .cursor-shadow {
      position: fixed;
      pointer-events: none;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(109,240,247,0.22), transparent 60%);
      filter: blur(18px);
      opacity: 0.6;
      transform: translate(-50%, -50%);
      z-index: 99;
      mix-blend-mode: screen;
    }
  </style>
  <div class="cursor-shadow" id="cursorShadow"></div>
  <div class="container" style="position:relative; z-index:1;">
    <div class="stars"></div>
    <div class="hero">
      <div class="poster-field" id="posterField"></div>
      <div class="hero-core">
        <h1 class="hero-title">ANIMATCH</h1>
        <p class="hero-sub">Find your character match</p>
        <button class="portal-btn" onclick="document.getElementById('file').click()">ENTER THE PORTAL</button>
      </div>
    </div>
    <section class="section reveal">
      <div class="app">
        <div class="panel upload-panel">
          <div class="upload-content">
            <div class="upload-grid">
              <div class="upload-left">
                <div class="upload-heading">
                  <div class="eyebrow">Input</div>
                  <div class="upload-title">Image</div>
                  <div class="upload-sub">JPG/PNG · frontal · even light</div>
                </div>
                <div class="upload-field">
                  <div class="field-label">File</div>
                  <div class="file-row">
                    <label class="file-button" for="file">Browse</label>
                    <span id="fileName" class="file-name">No file selected.</span>
                  </div>
                </div>
                <input type="file" id="file" class="file-input" accept="image/*">
                <input type="file" id="cameraInput" class="file-input" accept="image/*" capture="environment">
                <div class="range-row">
                  <span class="field-label">Results</span>
                  <input id="topKRange" class="range-input" type="range" min="4" max="12" step="2" value="8" />
                  <span id="topKValue" class="range-value">8</span>
                </div>
                <div class="toggle-row">
                  <label class="toggle-pill"><input type="checkbox" id="returnImage" checked> Landmarks overlay</label>
                </div>
              </div>
              <div class="upload-right">
                <div class="upload-actions">
                  <button class="btn" type="button" onclick="startCamera()">Take Photo</button>
                  <button id="go" class="btn primary">Match</button>
                </div>
                <div class="status" id="status"><span class="dot"></span><span id="statusText">Idle</span></div>
              </div>
            </div>
            <div id="quality" style="width:100%; max-width:720px; display:none;"></div>
            <div class="face-preview" id="facePreview" style="display:none;">
              <div class="mini-stack" id="miniLeftStack"></div>
              <img id="overlay" class="overlay overlay-center" style="display:none; max-width:420px;" alt="Landmarks overlay">
              <div class="mini-stack" id="miniRightStack"></div>
            </div>
          </div>
        </div>
        <div class="panel matches-panel">
          <h3 style="margin:0 0 8px;">Matches</h3>
          <div id="qualityPill" class="pill" style="margin:8px 0; display:none;"></div>
          <div id="compare" style="display:none; margin-bottom:12px;">
            <div class="overlay-frame">
              <div>
                <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Your landmarks</div>
                <img id="overlayCompare" style="display:none" alt="Your overlay">
              </div>
              <div>
                <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Selected match</div>
                <img id="matchCompare" style="display:none" alt="Match image">
              </div>
              <div>
                <div style="color:var(--muted); font-size:13px; margin-bottom:4px;">Match overlay</div>
                <img id="matchOverlayCompare" style="display:none" alt="Match overlay">
              </div>
            </div>
          </div>
          <div class="matches" id="matches"></div>
        </div>
      </div>
    </section>
    <section class="section reveal">
      <div class="hero-card" id="logosCard" style="position:relative; z-index:1; margin-top:16px;">
        <div class="feature-grid">
          <div>
            <div class="hero-metric" style="border:none; background:transparent; padding:4px 0 10px;">
              <div class="metric-label">Featured series</div>
            </div>
            <div class="series-strip" id="logosBar"></div>
          </div>
          <div class="feature-right">
            <div class="hero-metric" style="border:none; background:transparent; padding:4px 0 10px;">
              <div class="metric-label">Characters</div>
            </div>
            <div class="v-carousel" aria-label="Character reel">
              <div class="v-track" id="vCarousel"></div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="section reveal">
      <div class="panel stats-panel" id="statsPanel">
        <div class="eyebrow">Stats</div>
        <div class="stats-grid">
          <div class="stat">
            <div class="stat-value" id="statCharacters">329+</div>
            <div class="stat-label">Characters</div>
          </div>
          <div class="stat">
            <div class="stat-value" id="statSeries">50</div>
            <div class="stat-label">Series</div>
          </div>
          <div class="stat">
            <div class="stat-value">468</div>
            <div class="stat-label">Landmarks</div>
          </div>
          <div class="stat">
            <div class="stat-value small">MediaPipe FaceMesh</div>
            <div class="stat-label">Engine</div>
          </div>
        </div>
        <div class="stat-note">All processing is local. Images are not stored.</div>
      </div>
    </section>
  <button class="how-toggle" id="howToggle">How it works</button>
  <aside class="how-panel" id="howPanel">
    <button class="how-close" id="howClose">Close</button>
    <h4>How it works</h4>
    <div class="how-section">
      <h5>Input</h5>
      <ul>
        <li>Upload a JPG/PNG or capture with your camera.</li>
        <li>Face front-on, even light, image sharp.</li>
      </ul>
    </div>
    <div class="how-section">
      <h5>Landmarks</h5>
      <ul>
        <li>FaceMesh detects ~468 points on the face.</li>
        <li>If no face is found, you get a clear error.</li>
      </ul>
    </div>
    <div class="how-section">
      <h5>Ratios</h5>
      <ul>
        <li>We normalize to face size to stay scale-safe.</li>
        <li>Features: eye spacing, brow height, jaw angle, chin ratio, mouth width, nose length.</li>
      </ul>
    </div>
    <div class="how-section">
      <h5>Match</h5>
      <ul>
        <li>Compare against the anime vectors.</li>
        <li>Return top results with similarity + visuals.</li>
      </ul>
    </div>
  </aside>
  <!-- Camera modal -->
  <div class="camera-modal" id="cameraModal">
    <div class="camera-box">
      <video id="cameraVideo" autoplay playsinline muted></video>
      <div class="camera-controls">
        <button class="camera-btn cancel" type="button" onclick="stopCamera()">Cancel</button>
        <button class="camera-btn" type="button" onclick="snapPhoto()">Capture</button>
      </div>
    </div>
  </div>
  </div>
  <script>
    const api = "http://127.0.0.1:8000/match";
    const BADGE_THRESH = { good: 50, ok: 30 };
    const go = document.getElementById("go");
    const statusEl = document.getElementById("status");
    const statusText = document.getElementById("statusText");
    const qualityEl = document.getElementById("quality");
    const matchesEl = document.getElementById("matches");
    const overlayEl = document.getElementById("overlay");
    const overlayCompare = document.getElementById("overlayCompare");
    const matchCompare = document.getElementById("matchCompare");
    const matchOverlayCompare = document.getElementById("matchOverlayCompare");
    const compareBlock = document.getElementById("compare");
    const posterCarousel = document.getElementById("previewCarousel");
    const vCarousel = document.getElementById("vCarousel");
    const topKRange = document.getElementById("topKRange");
    const topKValue = document.getElementById("topKValue");
    const fileInput = document.getElementById("file");
    const cameraInput = document.getElementById("cameraInput");
    const cameraModal = document.getElementById("cameraModal");
    const cameraVideo = document.getElementById("cameraVideo");
    const fileNameLabel = document.getElementById("fileName");
    const statCharacters = document.getElementById("statCharacters");
    const statSeries = document.getElementById("statSeries");
    let selectedFile = null;
    let cameraStream = null;
    if (fileInput) {
      fileInput.addEventListener("change", () => {
        selectedFile = fileInput.files[0] || null;
        if (fileNameLabel) fileNameLabel.textContent = selectedFile ? selectedFile.name : "No file selected.";
      });
    }
    if (cameraInput) {
      cameraInput.addEventListener("change", () => {
        selectedFile = cameraInput.files[0] || null;
        if (selectedFile) {
          statusText.textContent = "Ready";
          if (fileNameLabel) fileNameLabel.textContent = selectedFile.name;
        }
      });
    }
    if (topKRange && topKValue) {
      topKRange.addEventListener("input", () => {
        topKValue.textContent = topKRange.value;
      });
    }
    const pickFile = () => {
      if (selectedFile) return selectedFile;
      if (cameraInput && cameraInput.files[0]) return cameraInput.files[0];
      if (fileInput && fileInput.files[0]) return fileInput.files[0];
      return null;
    };

    async function startCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        // fallback to native file input
        cameraInput?.click();
        return;
      }
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
        cameraVideo.srcObject = cameraStream;
        cameraModal.style.display = "flex";
      } catch (e) {
        console.error("Camera error", e);
        alert("Could not access camera. Please allow permissions or upload a photo.");
        cameraInput?.click();
      }
    }

    function stopCamera() {
      if (cameraStream) {
        cameraStream.getTracks().forEach(t => t.stop());
        cameraStream = null;
      }
      if (cameraModal) cameraModal.style.display = "none";
    }

    function snapPhoto() {
      if (!cameraVideo || !cameraVideo.videoWidth) return;
      const canvas = document.createElement("canvas");
      canvas.width = cameraVideo.videoWidth;
      canvas.height = cameraVideo.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(cameraVideo, 0, 0, canvas.width, canvas.height);
      canvas.toBlob(blob => {
        if (!blob) return;
        selectedFile = new File([blob], "camera.jpg", { type: "image/jpeg" });
        statusText.textContent = "Ready";
        if (fileNameLabel) fileNameLabel.textContent = selectedFile.name;
        stopCamera();
        runMatch(); // auto-run after capture
      }, "image/jpeg", 0.92);
    }
    function renderSkeleton(n=6) {
      matchesEl.innerHTML = "";
      for (let i=0; i<n; i++) {
        matchesEl.insertAdjacentHTML("beforeend", `
          <div class="skeleton-card">
            <div class="sk-img"></div>
            <div>
              <div class="sk-line" style="width:70%;"></div>
              <div class="sk-line sk-small"></div>
              <div class="sk-line"></div>
              <div class="sk-line sk-small"></div>
            </div>
          </div>
        `);
      }
    }

let portalTimer = null;
let portalIdx = 0;
let charactersData = [];
const posterField = document.getElementById("posterField");
const posters = [
  { name: "Attack on Titan", img: "https://cdn.myanimelist.net/images/anime/10/47347.jpg" },
  { name: "Demon Slayer", img: "https://cdn.myanimelist.net/images/anime/1286/99889.jpg" },
  { name: "Jujutsu Kaisen", img: "https://cdn.myanimelist.net/images/anime/1171/109222.jpg" },
  { name: "Naruto", img: "https://cdn.myanimelist.net/images/anime/13/17405.jpg" },
  { name: "Bleach", img: "https://cdn.myanimelist.net/images/anime/3/40451.jpg" },
  { name: "One Piece", img: "https://cdn.myanimelist.net/images/anime/6/73245.jpg" },
  { name: "Chainsaw Man", img: "https://cdn.myanimelist.net/images/anime/1806/126216.jpg" },
  { name: "Hunter x Hunter", img: "https://cdn.myanimelist.net/images/anime/1337/99013.jpg" },
  { name: "Death Note", img: "https://cdn.myanimelist.net/images/anime/9/9453.jpg" },
  { name: "Evangelion", img: "https://cdn.myanimelist.net/images/anime/1314/108941.jpg" }
];
const logos = [
  { name: "Attack on Titan", url: "https://myanimelist.net/anime/16498/Shingeki_no_Kyojin" },
  { name: "Demon Slayer", url: "https://myanimelist.net/anime/38000/Kimetsu_no_Yaiba" },
  { name: "Jujutsu Kaisen", url: "https://myanimelist.net/anime/40748/Jujutsu_Kaisen" },
  { name: "Naruto", url: "https://myanimelist.net/anime/20/Naruto" },
  { name: "Bleach", url: "https://myanimelist.net/anime/269/Bleach" },
  { name: "One Piece", url: "https://myanimelist.net/anime/21/One_Piece" },
  { name: "Chainsaw Man", url: "https://myanimelist.net/anime/44511/Chainsaw_Man" },
  { name: "Hunter x Hunter", url: "https://myanimelist.net/anime/11061/Hunter_x_Hunter_2011" },
  { name: "Death Note", url: "https://myanimelist.net/anime/1535/Death_Note" },
  { name: "Evangelion", url: "https://myanimelist.net/anime/30/Neon_Genesis_Evangelion" }
];

    async function loadPreviews() {
      try {
        if (!posterCarousel && !vCarousel) return;
        const res = await fetch("http://127.0.0.1:8000/characters");
        const data = await res.json();
        charactersData = data;
        // Duplicate list for seamless marquee
        const shuffled = data.slice(0, 80).sort(() => Math.random() - 0.5);
        const list = [...shuffled, ...shuffled, ...shuffled];
        if (posterCarousel) {
          posterCarousel.innerHTML = "";
          list.forEach(c => {
            const img = c.image_url ? `<img src="${c.image_url}" alt="${c.name}">` : `<div style="height:180px;background:rgba(255,255,255,0.05);border-radius:10px;"></div>`;
            posterCarousel.insertAdjacentHTML("beforeend", `
              <div class="card-preview">
                ${img}
                <div class="title">${c.name || c.id}</div>
                <div class="series">${c.series || ""}</div>
              </div>
            `);
          });
        }
        if (vCarousel) {
          vCarousel.innerHTML = "";
          const slice = data.slice(0, 60).sort(() => Math.random() - 0.5);
          const doubled = [...slice, ...slice];
          const track = doubled.map(c => {
            const img = c.image_url ? `<img src="${c.image_url}" alt="${c.name}">` : `<div style="height:150px;background:rgba(255,255,255,0.05);border-radius:10px;"></div>`;
            return `
              <div class="v-card">
                ${img}
                <div class="title">${c.name || c.id}</div>
                <div class="series">${c.series || ""}</div>
              </div>`;
          }).join("");
          vCarousel.innerHTML = track;
        }
        if (statCharacters) {
          statCharacters.textContent = `${data.length}+`;
        }
      } catch (e) {
        // ignore preview errors
      }
    }

    function buildLogos(seriesList) {
      const logosBar = document.getElementById("logosBar");
      const logosCard = document.getElementById("logosCard");
      if (!logosBar || !logosCard) return;
      const source = Array.isArray(seriesList) && seriesList.length ? seriesList : posters.map(p => ({ series: p.name, image_url: p.img, url: "#" }));
      const cards = source.map(s => {
        const style = s.image_url ? `style="background-image:url('${s.image_url}');"` : "";
        const href = s.url || "#";
        return `<a class="series-card" href="${href}" target="_blank" rel="noopener" ${style}><div class="name">${s.series}</div></a>`;
      }).join("");
      logosBar.innerHTML = cards;
      logosCard.style.display = cards ? "block" : "none";
    }

    async function loadSeries() {
      try {
        const res = await fetch("http://127.0.0.1:8000/series");
        const data = await res.json();
        buildLogos(data);
        if (statSeries) {
          statSeries.textContent = data.length.toString();
        }
      } catch (e) {
        buildLogos([]);
        if (statSeries) {
          statSeries.textContent = posters.length.toString();
        }
      }
    }


    function buildPosters() {
      if (!posterField) return;
      const positions = [
        { top: "14%", left: "6%" },
        { top: "12%", right: "8%" },
        { top: "44%", left: "10%" },
        { top: "50%", right: "12%" },
        { bottom: "12%", left: "8%" },
        { bottom: "12%", right: "10%" },
        { top: "24%", left: "32%" },
        { top: "26%", right: "32%" },
        { bottom: "24%", left: "30%" },
        { bottom: "26%", right: "30%" }
      ];
      posterField.innerHTML = posters.map((p, i) => {
        const pos = positions[i % positions.length];
        const stylePos = Object.entries(pos).map(([k,v]) => `${k}:${v};`).join("");
        const delay = (i % 5) * 1.1;
        return `<div class="poster-stack" style="${stylePos} animation-delay:${delay}s;">
                  <img src="${p.img}" alt="${p.name}">
                </div>`;
      }).join("");
    }

    loadSeries();
    loadPreviews();
    buildPosters();

    const revealItems = document.querySelectorAll(".reveal");
    if (revealItems.length) {
      const revealObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add("in-view");
              revealObserver.unobserve(entry.target);
            }
          });
        },
        { threshold: 0.18 }
      );
      revealItems.forEach((el) => revealObserver.observe(el));
    }

    // cursor shadow
    const cursorShadow = document.getElementById("cursorShadow");
    document.addEventListener("pointermove", (e) => {
      cursorShadow.style.left = `${e.clientX}px`;
      cursorShadow.style.top = `${e.clientY}px`;
    });
    const howToggle = document.getElementById("howToggle");
    const howPanel = document.getElementById("howPanel");
    const howClose = document.getElementById("howClose");
    if (howToggle && howPanel) {
      howToggle.addEventListener("click", () => howPanel.classList.add("open"));
    }
    if (howClose && howPanel) {
      howClose.addEventListener("click", () => howPanel.classList.remove("open"));
    }

    function qualityItem(label, value, ok=true) {
      const cls = ok === true ? "ok" : ok === false ? "bad" : "warn";
      return `<div class="item"><strong>${label}</strong><br><span class="${cls}">${value}</span></div>`;
    }

    function renderQuality(q) {
      qualityEl.innerHTML = "";
      qualityEl.style.display = "none";
    }

    function renderMatches(list) {
      matchesEl.innerHTML = "";
      if (!list || list.length === 0) {
        matchesEl.innerHTML = "<div style='color:var(--muted)'>No matches.</div>";
        return;
      }
      list.forEach((m, idx) => {
        const raw = m.similarity_pct !== undefined ? m.similarity_pct : Math.min(100, Math.max(0, (m.similarity || 0) * 100));
        const pct = Math.min(100, raw * 1.5);
        const reasons = (m.reasons || []).map(r => `<li>${r.reason}</li>`).join("");
        const img = m.image_url ? `<img src="${m.image_url}" alt="${m.name}" style="width:120px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);">` : "";
        const badge = m.badge ? m.badge : pct >= BADGE_THRESH.good ? "Good" : pct >= BADGE_THRESH.ok ? "OK" : "Weak";
        const badgeClass = badge === "Good" ? "good" : badge === "OK" ? "ok" : "weak";
        const card = `
          <div class="card">
            ${img || "<div style='width:120px;height:120px;background:rgba(255,255,255,0.05);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted);'>No image</div>"}
            <div>
              <div style="font-weight:700;font-size:16px;">${m.name || m.id}</div>
              <div style="color:var(--muted);font-size:13px;">${m.series || ""}</div>
              <div class="bar"><span style="width:${pct}%;"></span></div>
              <div style="font-size:13px;color:var(--muted);">Similarity: ${pct.toFixed(1)}% <span class="badge ${badgeClass}" style="margin-left:6px;">${badge}</span></div>
              <ul class="reasons">${reasons}</ul>
              <div style="display:flex; gap:6px; flex-wrap:wrap; margin-top:6px;">
                <button class="view-btn" data-idx="${idx}" style="padding:6px 10px;border-radius:6px;background:var(--accent-2);color:white;border:none;cursor:pointer;">View side-by-side</button>
              </div>
            </div>
          </div>
        `;
        matchesEl.insertAdjacentHTML("beforeend", card);
      });
    }

    async function runMatch() {
      const f = pickFile();
      if (!f) {
        alert("Pick a file or take a photo");
        return;
      }
      const topKRange = document.getElementById("topKRange");
      const topKVal = topKRange ? topKRange.value : 8;
      const form = new FormData();
      form.append("file", f);
      const params = new URLSearchParams();
      params.set("return_image", document.getElementById("returnImage").checked);
      params.set("top_k", topKVal);
      statusText.textContent = "Uploading...";
      overlayEl.style.display = "none";
      overlayEl.src = "";
      overlayCompare.style.display = "none";
      matchCompare.style.display = "none";
      matchOverlayCompare.style.display = "none";
      compareBlock.style.display = "none";
      qualityEl.innerHTML = "";
      matchesEl.innerHTML = "";
      try {
        renderSkeleton(6);
        const res = await fetch(`${api}?${params.toString()}`, { method: "POST", body: form });
        const data = await res.json();
        if (!res.ok) {
          statusText.textContent = `Error: ${data.detail || res.status}`;
          return;
        }
        statusText.textContent = "Done";
        renderQuality(data.quality);
        renderMatches(data.matches);
        // quality pill summary
        const qp = document.getElementById("qualityPill");
        if (qp && data.quality) {
          const q = data.quality;
          const issues = [];
          if (!q.lighting_ok) issues.push("lighting");
          if (!q.angle_ok) issues.push("angle");
          if (q.sharpness_ok === false) issues.push("sharpness");
          if (q.face_size_ok === false) issues.push("face size");
          if (issues.length === 0) {
            qp.textContent = "Quality: good";
          } else {
            qp.textContent = "Quality: needs " + issues.join(", ");
          }
          qp.style.display = "inline-flex";
        }
        const facePreview = document.getElementById("facePreview");
        const miniLeftStack = document.getElementById("miniLeftStack");
        const miniRightStack = document.getElementById("miniRightStack");
        if (data.debug_image_b64) {
          overlayEl.src = "data:image/png;base64," + data.debug_image_b64;
          overlayEl.style.display = "block";
          overlayCompare.src = overlayEl.src;
          overlayCompare.style.display = "block";
          facePreview.style.display = "flex";
        } else {
          facePreview.style.display = "none";
        }
        // populate side matches (3 on each side)
        const leftThree = data.matches ? data.matches.slice(0, 3) : [];
        const rightThree = data.matches ? data.matches.slice(3, 6) : [];
        miniLeftStack.innerHTML = leftThree.map(m => `
          <div class="match-mini">
            ${m.image_url ? `<img src="${m.image_url}" alt="${m.name}">` : ""}
            <div>
              <div class="name">${m.name || m.id}</div>
              <div class="series">${m.series || ""}</div>
              <div class="series">${(Math.min(100, (m.similarity_pct || ((m.similarity||0)*100)) * 1.5)).toFixed(1)}%</div>
            </div>
          </div>
        `).join("");
        miniRightStack.innerHTML = rightThree.map(m => `
          <div class="match-mini">
            ${m.image_url ? `<img src="${m.image_url}" alt="${m.name}">` : ""}
            <div>
              <div class="name">${m.name || m.id}</div>
              <div class="series">${m.series || ""}</div>
              <div class="series">${(Math.min(100, (m.similarity_pct || ((m.similarity||0)*100)) * 1.5)).toFixed(1)}%</div>
            </div>
          </div>
        `).join("");
        // attach click handlers for side-by-side
        document.querySelectorAll(".view-btn").forEach(btn => {
          btn.onclick = () => {
            const idx = parseInt(btn.dataset.idx, 10);
            const m = data.matches[idx];
            if (m && m.image_url) {
              matchCompare.src = m.image_url;
              matchCompare.style.display = "block";
            } else {
              matchCompare.style.display = "none";
            }
            if (m && m.overlay_url) {
              matchOverlayCompare.src = m.overlay_url;
              matchOverlayCompare.style.display = "block";
              matchOverlayCompare.alt = "Match overlay";
            } else {
              matchOverlayCompare.removeAttribute("src");
              matchOverlayCompare.style.display = "block";
              matchOverlayCompare.alt = "Match overlay not available";
              matchOverlayCompare.style.background = "rgba(255,255,255,0.04)";
              matchOverlayCompare.style.height = "100px";
            }
            if (matchCompare.style.display === "block" || matchOverlayCompare.style.display === "block") {
              compareBlock.style.display = "block";
            }
          };
        });
        // Hide empty overlay slots
        if (!document.getElementById("matchOverlayCompare").src) {
          document.getElementById("matchOverlayCompare").style.display = "none";
        }
      } catch (e) {
        statusText.textContent = `Error: ${e}`;
      }
    }

    go.onclick = runMatch;
  </script>
</body>
</html>
